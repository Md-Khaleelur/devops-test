pipeline {
    agent any
     environment {
                registry = "docker.pkg.github.com/md-khaleelur/devops-test/book"
                registryCredential = 'github-registry'
                dockerImage=''
      }
    stages {
        stage('Build') {
            steps {
                checkout scm
                sh 'pwd'
//               sh 'cd book-discovery-app/bc-5-backend/book-management-service && mvn -B -DskipTests clean package'
            }
        }
        stage('Test') {
            steps {
                sh 'pwd'
//                 sh 'cd book-discovery-app/bc-5-backend/book-management-service && mvn test'
                sh 'cd book-discovery-app/bc-5-frontend && ls && rm -rf node_modules/ && npm install && npm run test'
            }
        }
        stage('Building Docker Image') {
              steps{
                dir("book-discovery-app/bc-5-backend/book-management-service"){
                      script {
                                 dockerImage = docker.build registry + ":$BUILD_NUMBER"
                             }
                       }
                      }
          }
         stage('Deploy Docker Image to Dockerhub') {
                    steps{
        //               sh 'cat ~/GH_TOKEN.txt | docker login docker.pkg.github.com -u narenraj701 --password-stdin'
                      sh 'docker login docker.pkg.github.com -u Md-Khaleelur -p 51ecf7857b62a662d6275a6c325dab3ace3afacf'
                      sh 'docker push '+registry+":$BUILD_NUMBER"
        //                 script {
        //
        //                   docker.withRegistry( '', registryCredential ) {
        //                     dockerImage.push()
        //                   }
        //                 }
                      }
                    }
    }
}
